<!-- Starter code and data adapted from http://duspviz.mit.edu/d3-workshop/mapping-data-with-d3/ -->
<html>

<head>
    <title>A Basic D3 map</title>
    <script src="http://d3js.org/d3.v4.js" charset="utf-8"></script>

    <script src="data/boston_neighborhoods.json"></script>
    <script src="data/201903-bluebikes-tripdata.csv"></script>
    <script src="process_data.js"></script>

    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>

    <script src="https://d3js.org/d3-voronoi.v1.min.js"></script>
</head>>

<body>
    <script>
        console.log("Running javascript.")

        var width = 700;
        var height = 580;


        var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var g = svg.append("g");

        var albersProjection = d3.geoAlbers()
            .scale(190000)
            .rotate([71.057, 0])
            .center([0, 42.313])
            .translate([width / 2, height / 2]);

        var geoPath = d3.geoPath()
            .projection(albersProjection);

        g.selectAll("path")
            .data(neighborhoods_json.features)
            .enter()
            .append("path")
            .attr("fill", "#ccc")
            .attr("stroke", "#333")
            .attr("d", geoPath);

        // Load Bluebike station data
        d3.queue()
            .defer(d3.csv, "https://raw.githubusercontent.com/6859-sp21/a4-bikerides/main/bluebikes_2020_stations.csv")
            .await(ready)

        function ready(error, stationData) {
            console.log("ready() called")
            console.log("stationData: ", stationData)

            // g.selectAll("circle")
            // .data([{ x: 50, y: 50 }])
            // .enter()
            // .append('circle')
            // .attr("r", 25)
            // .attr("cx", d => d.x)
            // .attr("cy", d => d.y)

            // https://observablehq.com/@mbostock/u-s-airports-voronoi
            // Voronoi cells
            var voronoi = d3.voronoi() //.extent([0,0], [width, height])
            voronoi.x((d) => d.latitude)
            voronoi.y((d) => d.longitude)

            var polys = voronoi(stationData).polygons()
            console.log("polys: ", polys)
            var cellG = svg.append("g")
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("pointer-events", "all");

            cellG.selectAll("path")
                .data(polys)
                .enter()
                .append("path")
                .attr("d", polygonF)
                // .attr("d", d3.geoPath(albersProjection))


            function polygonF(d) {
                console.log("d: ",d)

                d = d.filter(v => v != null)

                let p = d.map(v => {
                    return albersProjection([v[1], v[0]]) 
                })
                console.log("p: ", p)
                // let p = albersProjection([d[1], d[0]])
                // console.log(p)
                return "M" + p.join("L") + "Z";
            }

            cellG.selectAll("circle")
                .data(stationData)
                .enter()
                .append('circle')
                .attr("r", 2)
                .attr("transform", function (d) {
                    return "translate(" + albersProjection([d.longitude, d.latitude]) + ")"
                })


            // svg.append("g")
            //     .attr("fill", "none")
            //     .attr("stroke", "red")
            //     .attr("pointer-events", "all")
            // .selectAll("path")
            // .data(v.polygons(stationData).features)
            // .enter()
            // .append("path")
            //     .attr("d", d3.geoPath(albersProjection))




            // g.selectAll("circle")
            //     .data([{ latitude: "42.387151", longitude: "-71.075978", "station id": "1", "station name": "18 Dorrance Warehouse" },
            //     { x: 50, y: 50, latitude: "42.267902", longitude: "-71.093641" }])
            //     .enter()
            //     .append('circle')
            //     .attr("r", 10)
            //     .attr("transform", function (d) {
            //         return "translate(" + albersProjection([d.longitude, d.latitude]) + ")"
            //     })

            // svg.selectAll('.station')
            //     .data(stationData)
            //     .join('circle')
            //         .attr("transform", function(d) {
            //             return "translate(" + albersProjection([d.longitude, d.latitude]) + ")"
            //         })

        }

    </script>
</body>

</html>